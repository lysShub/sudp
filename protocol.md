# SUDP

适用于文件传输的可靠UDP。

### 包格式

​      `原始数据 包头`；与大多数数据包格式不同，**SUDP**的首部在最后

#### 包头

`数据偏置(38b) 最后包(1b) 备用(1b) 校验(4B) `

- 校验使用CRC32（0x104C11DB7）；校验的数据是之前所有的数据。

- 数据偏置表示此数据包第一字节在文件中的位置，第一个数据包的的数据偏置应该为0。此参数限制了最大传输文件大小，`2^38-1=274,877,906,944-1=256GB-1B`。我们规定最大传输大小为`0011 1111 1111 1111 1111 1111 0000 0000 0000 0000` = 274,877,841,408 Byte ~= 255.99GB； 当偏置大于此值时不是数据包包。

- 最后包为1表示是此文件的最后一个数据包，并不表示此文件传输完成。非数据包的值应该是0。

  

#### 包格式



###### 任务请求包

​		receiver->sender：请求传输，偏置：`0011 1111 1111 1111 1111 1111 0000 0000 0000 0000`；数据部分可以自行设计，通常设计为权鉴。

###### 任务握手包

​		sender->receiver：信息确认，偏置：`0011 1111 1111 1111 1111 1111 1000 0000 0000 0000`；数据部分:    `版本(1B) MTU(2B) 是否加密(1B)` 。版本要相同，MTU与本地相较取小值。sender应该持续发送此包知道收到确认握手包。如果需要加密，则所有文件包和任务开始包、任务中止包、任务结束包都会被加密。加密方式为将整个数据包(包括包头)填充为16字节整数倍，然后对齐进行加密。

###### 任务确认握手包

​		receiver->sender：偏置：`0011 1111 1111 1111 1111 1111 0100 0000 0000 0000`；数据部分:    `确认握手代码(1B)  MTU(2B) 公钥(162B)` 。确认握手代码代表握手结果，只有当其为`0b00000000`时才成功；如果不需要加密，公钥部分为162Byte的零值。握手代码：0：握手成功；10：版本不同。。。

###### 任务确认确认握手包

​		sender->receiver：偏置：`0011 1111 1111 1111 1111 1111 0010 0000 0000 0000`；数据部分为128B的使用非对称加密(RSA-OAEP 128)的公钥加密密钥。表示握手成功、密钥发放完成<font color="red">。</font>

###### 任务开始包

 		receiver->sender：偏置：`0011 1111 1111 1111 1111 1111 0001 0000 0000 0000`，数据部分为安全加密后的密钥 。

###### 任务中止包

​		receiver<->sender：表示任务由于意外中止，偏置：`0011 1111 1111 1111 1111 1111 0000 1000 0000 0000`，数据部分为安全加密后的密钥。

###### 任务结束包

​		sender->receiver：表示传输任务的结束。偏置：`0011 1111 1111 1111 1111 1111 1111 1111 0000 0000`，数据部分为安全加密后的密钥。

​                                     ---------------------------------------------------------------------------------------------------------------------------------

######  文件信息包

​    	sender->receiver：承载有文件的信息，表示准备开始一个文件传输，偏置：`0011 1111 1111 1111 1111 1111 0000 0000 0000 0001`。数据部分为经过安全加密的`密钥(16B) 文件大小(5B) 文件名(可变长度)`。

###### 文件开始包

​		receiver->sender：表示receiver收到了文件信息包， 偏置：`0011 1111 1111 1111 1111 1111 0000 0000 0000 0010`，数据部分为经过安全加密的密钥。sender收到此包后开始发送数据包。

###### 文件数据包

​    	sender->receiver：承载的是文件数据。偏置小于`0011 1111 1111 1111 1111 1111 0000 0000 0000 0000` 。

###### 文件重发包

​		receiver->sender：用于控制重发数据偏置：`0011 1111 1111 1111 1111 1111 0000 0000 0000 0100`。数据部分为经过安全加密的`密钥(16B) 起始偏置(5B) 结束偏置(5B) ...`。偏置前后是闭合的。

###### 文件进度包

​		receiver->sender：回复已连续的、完成的传输进度，3s周期性地回复，偏置：`0011 1111 1111 1111 1111 1111 0000 0000 0000 1000`；数据部分为经过安全加密的`密钥(16B) 已完成偏置(5B)`。此包为断点重传提供了支持；同时充当心跳包的作用，发送方如果超时没有获得此包则中止传输。

###### 文件速度包

​		receiver->sender：用于控制传输速度：`0011 1111 1111 1111 1111 1111 0000 0000 0001 0000`，数据部分为经过安全加密的`密钥(16B) 设定速度(4B)`。

###### 文件结束包

​		receiver->sender：表示一个文件传输结束，偏置：`0011 1111 1111 1111 1111 1111 0000 0000 1111 1111`；数据部分为经过安全加密的密钥

**说明：** 关于安全加密，是仅将数据包中数据部分部分使用密钥加密，不加密包头；并且可以发现需要经过安全加密的原始数据前16B及是密钥；取名安全加密只为与数据包加密进行区分。







###  流程控制

​		**发送方不需要对方地址**

​		**只有点对点传输模式，即一个端口号只能同时进行一个传输任务**



​		SUDP可以实现一个对文件的传输，由接受方开始的。发送方主要传入UDPConn即可，适用于单次文件传输，等待方面：发送方将超长等待接收请求包，接收方发送请求包后只等待小段时间、超时将非报错，这要求发送方需要提前准备好。

​		点对点传输实践：传输单个文件时，传输双方都需要知道对方的地址，发送方先准备好，然后即执行上方流程。传输多个文件时，在文件信息包和文件结束包之间循环。



### 杂项

1. 发送以1/16s(62.5ms)为周期
2. 速度记录不包括SUDP包头
3. 最后包发送完成后，周期性扫描发送策略